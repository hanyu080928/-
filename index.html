<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å…¬æ¬¾è®°å½•ç³»ç»Ÿ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {font-family: "Segoe UI", Arial, sans-serif;margin: 0;background: #f4f6f9;color: #333;}
    header {background: linear-gradient(135deg, #4e73df, #1cc88a);color: white;padding: 15px 20px;display: flex;align-items: center;box-shadow: 0 3px 6px rgba(0,0,0,0.2);}
    header h1 {margin: 0;font-size: 20px;flex: 1;text-align: center;}
    .sidebar {height: 100%;width: 0;position: fixed;top: 0;left: 0;background: #fff;box-shadow: 2px 0 8px rgba(0,0,0,0.2);overflow-x: hidden;transition: 0.3s;padding-top: 60px;z-index: 999;}
    .sidebar a {padding: 15px 25px;text-decoration: none;font-size: 16px;color: #333;display: block;transition: 0.2s;}
    .sidebar a:hover {background: #f4f6f9;color: #4e73df;}
    .openbtn {font-size: 20px;cursor: pointer;background: none;border: none;color: white;}
    main {padding: 20px;max-width: 1000px;margin: auto;}
    .card {background: white;border-radius: 12px;padding: 20px;margin-bottom: 20px;box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
    .card h2 {margin-top: 0;color: #4e73df;}
    button.action, .user-btn {background: #4e73df;color: white;cursor: pointer;border: none;border-radius: 6px;padding: 10px 15px;margin: 5px;font-size: 14px;}
    .user-btn:hover, button.action:hover {background: #2e59d9;}
    table {width: 100%;border-collapse: collapse;margin: 15px 0;}
    th, td {border: 1px solid #eee;padding: 10px;text-align: center;}
    th {background: #f8f9fc;}
    .alert {color: red;font-weight: bold;margin-top: 10px;}
    .stats {display: flex;justify-content: space-between;flex-wrap: wrap;}
    .stat-box {flex: 1;min-width: 200px;background: #f8f9fc;border-radius: 8px;margin: 10px;padding: 15px;text-align: center;}
    .stat-box h3 {margin: 5px 0;font-size: 18px;}
    .stat-box p {font-size: 20px;font-weight: bold;color: #1cc88a;}
    .tab-content {display: none;}
    .tab-content.active {display: block;}
    .spend-card {background: #f8f9fc;border-left: 6px solid #e74a3b;padding: 10px 15px;margin: 10px 0;border-radius: 6px;}
    .spend-card h4 {margin: 0;color: #e74a3b;}
    .spend-card small {color: gray;}
  </style>
</head>
<body onload="checkMonth()">
  <header>
    <button class="openbtn" onclick="openNav()">â˜°</button>
    <h1>ğŸ’° å…¬æ¬¾è®°å½•ç³»ç»Ÿ</h1>
  </header>

  <!-- ä¾§è¾¹æ  -->
  <div id="mySidebar" class="sidebar">
    <a href="javascript:void(0)" onclick="showTab('payTab');closeNav()">äº¤é’±è®°å½•</a>
    <a href="javascript:void(0)" onclick="showTab('spendTab');closeNav()">æ”¯å‡ºè®°å½•</a>
    <a href="javascript:void(0)" onclick="showTab('historyTab');closeNav()">å†å²è®°å½•</a>
    <a href="javascript:void(0)" onclick="showTab('incomeTab');closeNav()">æ”¶å…¥è®°å½•</a>
  </div>

  <main>
    <!-- äº¤é’±è®°å½• -->
    <div id="payTab" class="tab-content active card">
      <h2>äº¤é’±è®°å½•</h2>
      <div id="userButtons"></div>
      <table id="paymentTable"><thead><tr><th>å§“å</th><th>æ˜¯å¦äº¤é’±</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- æ”¯å‡ºè®°å½• -->
    <div id="spendTab" class="tab-content card">
      <h2>è®°å½•æ¶ˆè´¹</h2>
      <input type="text" id="remark" placeholder="èŠ±äº†ä»€ä¹ˆ">
      <input type="number" id="amount" placeholder="é‡‘é¢ (RM)">
      <button class="action" onclick="spend()">è®°å½•æ¶ˆè´¹</button>
      <p id="warning" class="alert"></p>
      <div id="spendList"></div>
    </div>

    <!-- å†å²è®°å½• -->
    <div id="historyTab" class="tab-content card">
      <h2>å†å²è®°å½•</h2>
      <table id="historyTable"><thead><tr><th>ç±»å‹</th><th>å§“å/å¤‡æ³¨</th><th>é‡‘é¢</th></tr></thead><tbody></tbody></table>
      <div class="stats">
        <div class="stat-box"><h3>æ€»æ”¶å…¥</h3><p id="totalIn">0</p></div>
        <div class="stat-box"><h3>æ€»æ”¯å‡º</h3><p id="totalOut">0</p></div>
        <div class="stat-box"><h3>ä½™é¢</h3><p id="balance">0</p></div>
      </div>
      <canvas id="chart" height="150"></canvas>
    </div>

    <!-- æ”¶å…¥è®°å½• -->
    <div id="incomeTab" class="tab-content card">
      <h2>æ”¶å…¥è®°å½•ï¼ˆæ¯æœˆï¼‰</h2>
      <div id="incomeHistoryList"></div>
    </div>
  </main>

  <script>
    const members = ["shao xiang","rain","kian","yong liang","heng jing","CJ","Tommy"];
    let payments = JSON.parse(localStorage.getItem("payments")) || {};
    let history = JSON.parse(localStorage.getItem("history")) || [];
    let totalIn = parseFloat(localStorage.getItem("totalIn")) || 0;
    let totalOut = parseFloat(localStorage.getItem("totalOut")) || 0;
    let incomeHistory = JSON.parse(localStorage.getItem("incomeHistory")) || {};
    let currentMonth = localStorage.getItem("currentMonth") || "";

    // æ‰“å¼€/å…³é—­ä¾§è¾¹æ 
    function openNav(){document.getElementById("mySidebar").style.width="220px";}
    function closeNav(){document.getElementById("mySidebar").style.width="0";}
    function showTab(tabId){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById(tabId).classList.add('active');}

    // æ£€æŸ¥æœˆä»½
    function checkMonth(){
      const now = new Date();
      const monthKey = now.getFullYear()+"-"+(now.getMonth()+1);
      if(monthKey!==currentMonth){
        if(currentMonth){incomeHistory[currentMonth] = {...payments};}
        payments={};currentMonth=monthKey;
        localStorage.setItem("incomeHistory",JSON.stringify(incomeHistory));
        localStorage.setItem("currentMonth",currentMonth);
        localStorage.setItem("payments",JSON.stringify(payments));
      }
      update();
    }

    // åˆå§‹åŒ–äº¤é’±è¡¨
    function initTable(){
      const tbody=document.querySelector("#paymentTable tbody");tbody.innerHTML="";
      members.forEach(name=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${name}</td><td>${payments[name]?"âœ… å·²äº¤":"âŒ æœªäº¤"}</td>`;
        tbody.appendChild(tr);
      });
      const userBtns=document.getElementById("userButtons");userBtns.innerHTML="";
      members.forEach(name=>{
        const btn=document.createElement("button");
        btn.className="user-btn";btn.textContent=name+" +RM10";
        btn.onclick=()=>pay(name);userBtns.appendChild(btn);
      });
    }

    // äº¤é’±
    function pay(payer){
      payments[payer]=true;totalIn+=10;
      history.push({type:"æ”¶å…¥",name:payer,amount:10,date:new Date().toLocaleString()});
      save();update();
    }

    // æ¶ˆè´¹
    function spend(){
      const remark=document.getElementById("remark").value;
      const amount=parseFloat(document.getElementById("amount").value);
      if(!remark||!amount)return alert("è¯·è¾“å…¥å¤‡æ³¨å’Œé‡‘é¢ï¼");
      if(amount>(totalIn-totalOut)){document.getElementById("warning").textContent="âš  ä¸å¤Ÿé’±ï¼ä½™é¢ä¸è¶³";return;}
      document.getElementById("warning").textContent="";
      totalOut+=amount;
      history.push({type:"æ”¯å‡º",name:remark,amount:amount,date:new Date().toLocaleString()});
      save();update();document.getElementById("remark").value="";document.getElementById("amount").value="";
    }

    // æ›´æ–°ç•Œé¢
    function update(){
      initTable();
      const tbody=document.querySelector("#historyTable tbody");tbody.innerHTML="";
      history.forEach(item=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${item.type}</td><td>${item.name}</td><td>RM ${item.amount}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById("totalIn").textContent="RM "+totalIn;
      document.getElementById("totalOut").textContent="RM "+totalOut;
      document.getElementById("balance").textContent="RM "+(totalIn-totalOut);
      const spendList=document.getElementById("spendList");spendList.innerHTML="";
      history.filter(h=>h.type==="æ”¯å‡º").forEach(s=>{
        const div=document.createElement("div");
        div.className="spend-card";
        div.innerHTML=`<h4>${s.name}</h4><p>RM ${s.amount}</p><small>${new Date(s.date).toLocaleString()}</small>`;
        spendList.prepend(div);
      });
      updateIncomeHistory();updateChart();
    }

    // ä¿å­˜åˆ° localStorage
    function save(){
      localStorage.setItem("payments",JSON.stringify(payments));
      localStorage.setItem("history",JSON.stringify(history));
      localStorage.setItem("totalIn",totalIn);
      localStorage.setItem("totalOut",totalOut);
      localStorage.setItem("incomeHistory",JSON.stringify(incomeHistory));
      localStorage.setItem("currentMonth",currentMonth);
    
    }
    // æ”¶å…¥è®°å½•å†å²
    function updateIncomeHistory(){
      const list=document.getElementById("incomeHistoryList");list.innerHTML="";
      for(let month in incomeHistory){
        let html=`<div class="card"><h3>${month}</h3><table><tr><th>å§“å</th><th>æ˜¯å¦äº¤é’±</th></tr>`;
        members.forEach(name=> {
          const paid=incomeHistory[month][name]?"âœ… å·²äº¤":"âŒ æœªäº¤";
          html+=`<tr><td>${name}</td><td>${paid}</td></tr>`;
        });
        html+="</table></div>";
    
        list.innerHTML=html+list.innerHTML;
      }
    }


    // å›¾è¡¨
    let chart;
    function updateChart(){
      const ctx=document.getElementById("chart").getContext("2d");
      const spendData=history.filter(h=>h.type==="æ”¯å‡º");
      const categories={};spendData.forEach(s=>{categories[s.name]=(categories[s.name]||0)+s.amount;});
      const labels=Object.keys(categories);const data=Object.values(categories);
      if(chart)chart.destroy();
      chart=new Chart(ctx,{type:"pie",data:{labels:labels,datasets:[{data:data,backgroundColor:["#4e73df","#1cc88a","#36b9cc","#f6c23e","#e74a3b","#858796","#20c997"]}]}});}
  </script>
</body>
</html>